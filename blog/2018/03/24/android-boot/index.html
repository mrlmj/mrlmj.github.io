
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Andorid启动流程探索 - AndroidDev</title>
  <meta name="author" content="放开那个猴子">

  
  <meta name="description" content="最近在了解OTA升级方面的东西，学习的过程中，对Android的启动流程产生了很大的兴趣，很好奇为什么调用了RecoverySystem#installPackage方法之后手机重启就自动进入升级界面开始升级？Android整个系统的启动流程到底是怎样的（之前只是有过简单的了解）。 &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.monkeyliu.com/blog/2018/03/24/android-boot/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="AndroidDev" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/favicon.ico" rel="icon">
<!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/blog">AndroidDev</a></h1>
  
    <h2>坚持比完美更重要</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="www.monkeyliu.com">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/blog">博客</a></li>
  <li><a href="/blog/archives">归档</a></li>
  <li><a href="/blog/about.html">关于</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Andorid启动流程探索</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2018-03-24T09:48:26+08:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>24</span><span class='date-suffix'>th</span>, <span class='date-year'>2018</span></span> <span class='time'>9:48 am</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><p>最近在了解OTA升级方面的东西，学习的过程中，对Android的启动流程产生了很大的兴趣，很好奇为什么调用了<code>RecoverySystem#installPackage</code>方法之后手机重启就自动进入升级界面开始升级？Android整个系统的启动流程到底是怎样的（之前只是有过简单的了解）。加上之前对bootloader、recovery等概念比较模糊，刷机的时候一般也都是按照网上的方法做，很不程序员，于是打算把这些东西梳理一下。</p>

<p>本篇文章主要是探索Android手机启动的流程，包括正常的模式（按下电源键到系统正常启动的整个流程）和一些其他的模式（比如进入recovery升级、线刷等）。掌握之后刷机就不用再去各种找教程，直接拿到刷机包一顿操作就行。</p>

<!-- more -->


<h3>Android手机正常启动流程</h3>

<p>首先需要梳理一下Android手机正常启动的整个流程是怎样的，也就是当我们按下电源键一直到看到Launcher中间经历了什么！整个过程会从简表述，抛开其中很多不重要的细节，从比较高的层次以容易懂的语言来看这个过程。</p>

<p>首先，操作系统的启动是一个比较矛盾的过程：必须先运行程序，然后计算机才能启动，但是计算机不启动就无法运行程序！ 早期采取的措施就是：将一小段程序固化在ROM中，计算机启动时，先去将它读入到内存中执行，进而将整个操作系统运行起来。在Windows上这段程序称之为BIOS（基本输入输出系统），对应的在Android中我们称之为BootLoader。</p>

<p><strong>Android电源键按下时，首先从ROM的固定位置读取这段BootLoader程序（加载到RAM中）</strong>。BootLoader完成的工作大致有：</p>

<p>初始化RAM、硬件，加载内核，跳转到内核中由其继续完成接下来的工作。</p>

<p>在内核模块中，主要进行大部分硬件、驱动、文件系统的初始化，在最后创建<code>init</code>进程，这是Android中的第一个进程！ init进程中会执行init.rc脚本，其中最特别是创建了Zygote受精卵进程。在Zygote进程会预先加载App需要的一些资源和Android的framework class，之后其他App进程的创建都是直接fork Zygote进程，它们共用这些资源，节省开销！<em>（像Xposed框架就是在Zygote进程中插入hook代码，这样所有应用调用到framework api，都会执行到它的逻辑，因为共用了相同的内存资源）</em></p>

<p>有一个例外是，SystemServer进程不是fork Zygote而来，SystemServer中完成了大量系统服务的启动，比如我们经常接触到的WindowMangerService、ActivityManagerService、PackageManagerService等等。在ActivityManagerServie启动之后，发出action为<code>Intent.CATEGORY_HOME</code>的intent，启动Launcher应用，至此Andorid系统启动完毕！</p>

<p>正常启动的流程是不是非常简单，最后来总结一下：</p>

<p><strong>按下电源键 —>   cpu加载BootLoader到内存中执行   —>  初始化硬件、进入内核模块   —>  内核模块中加载驱动、文件系统、创建第一个进程Zygote —> 创建一些系列的SystemServer，发送Home Intent  —> Launcher启动</strong></p>

<h3>Recovery模式（卡刷）</h3>

<p>刷过机的同学可能都知道Recovery这个东西，一般是通过长按组合键（不同手机不同组合键）进入Recovery然后安装升级包之类的。那Recovery到底是个什么东东呢，怎么进入到Recovery模式中的。</p>

<p>其实Recovery模式也是一个小的操作系统，只不过我们看到的只是一个小小的简单界面，而正常的Android系统是可以看到Launcher应用和各种其他应用。有点类似于windows上的U盘启动盘用来修复、更新主系统的。</p>

<p><strong>那Recovery模式是怎么进去的呢？</strong></p>

<p>上面讲过正常的流程中，BootLoader程序会初始化RAM、硬件，然后加载内核。如果我们在BootLoader启动的时候按下了对应的组合按键（比如音量-和电源键），BootLoader检测到之后同样会加载内核，但是此时加载的不是boot分区的内核，而是recovery分区的内核，在recovery分区的内核中初始化了一个简单的文件系统可供我们选择升级包进行升级。同时也会创建init进程执行自己的init脚本（源码<code>bootable/recovery/etc/init.rc</code>)，其中做了一件非常重要的事情，<strong>启动recovery服务</strong>（源码<code>bootable/recovery/recovery.cpp</code>），这个服务稍后会讲解一下做了什么事情。</p>

<p>除了长按组合键这种进入Recovery模式的方式，还可以执行adb命令 <code>adb shell reboot recovery</code>，重启后进入Recovery模式。这种方式是怎么进入Recovery模式的呢？</p>

<p>当BootLoader在执行过程中没有检测到任何组合按键，就会去MISC分区的启动控制信息块BCB（Bootloader Control Block）。BCB是一个结构体，存放着启动命令，根据这个命令，系统可以进入三种不同的启动模式</p>

<p>[@BCB结构体]</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">struct</span> <span class="n">bootloader_message</span><span class="p">{</span>
</span><span class='line'>     <span class="kt">char</span> <span class="n">command</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>  <span class="c1">//存放不同的启动命令</span>
</span><span class='line'>
</span><span class='line'>     <span class="kt">char</span> <span class="n">status</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>   <span class="c1">//update-radio或update-hboot完成存放执行结果</span>
</span><span class='line'>
</span><span class='line'>     <span class="kt">char</span> <span class="n">recovery</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span> <span class="c1">//存放在/cache/recovery/command中的命令</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>当结构体中command为空时，进入正常的系统启动流程。</p>

<p>当结构体中command字段为"boot-recovery"时，则进入Recovery模式，进行下一步的功能。</p>

<p>所以，执行adb命令进入就是将"boot-recovery"这个字段写入了BCB的command字段中，然后重启系统。</p>

<p>同样，在安装OTA升级包的时候通常会调用一个这样的接口<code>RecoverySystem#installPackage</code>，然后就会重启进入到升级页面。其实，在调用了这个接口之后，会将"boot-recovery"写入BCB的command字段， 然后重启设备。 这样，设备重启之后，读取到BCB的command跳转到Recovery中启动Recovery服务进行OTA包升级。</p>

<p><strong>总结：</strong></p>

<ol>
<li>Recovery模式是一个mini的操作系统，主要启动自己的Recovery服务搞一些事情（具体下面细说）。</li>
<li>进入Recovery模式有三种方式：长按组合键、adb reboot recovery、RecoverySystem#installPackage等API接口。 第一种方式是BootLoader执行过程中检测的。 后两种方式原理相同，都是修改BCB的内容，然后BootLoader读取跳转。</li>
</ol>


<h3>Recovery服务的细节</h3>

<p>上面介绍了进入Recovery的大概流程，提到了一个Recovery的服务，Recovery能提供的功能基本都在这个服务中定义，可以从源码的注释中可以详细了解到Recovery提供的全部服务：</p>

<p>[@bootable/recovery/recovery.cpp]</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="cm">/* </span>
</span><span class='line'><span class="cm"> * The recovery tool communicates with the main system through /cache files. </span>
</span><span class='line'><span class="cm"> *   /cache/recovery/command - INPUT - command line for tool, one arg per line </span>
</span><span class='line'><span class="cm"> *   /cache/recovery/log - OUTPUT - combined log file from recovery run(s) </span>
</span><span class='line'><span class="cm"> *   /cache/recovery/intent - OUTPUT - intent that was passed in </span>
</span><span class='line'><span class="cm"> * </span>
</span><span class='line'><span class="cm"> * The arguments which may be supplied in the recovery.command file: </span>
</span><span class='line'><span class="cm"> *   --send_intent=anystring - write the text out to recovery.intent </span>
</span><span class='line'><span class="cm"> *   --update_package=path - verify install an OTA package file </span>
</span><span class='line'><span class="cm"> *   --wipe_data - erase user data (and cache), then reboot </span>
</span><span class='line'><span class="cm"> *   --wipe_cache - wipe cache (but not user data), then reboot </span>
</span><span class='line'><span class="cm"> *   --set_encrypted_filesystem=on|off - enables / diasables encrypted fs </span>
</span><span class='line'><span class="cm"> * </span>
</span><span class='line'><span class="cm"> * After completing, we remove /cache/recovery/command and reboot. </span>
</span><span class='line'><span class="cm"> * Arguments may also be supplied in the bootloader control block (BCB). </span>
</span><span class='line'><span class="cm"> * These important scenarios must be safely restartable at any point: </span>
</span><span class='line'><span class="cm"> * </span>
</span><span class='line'><span class="cm"> * FACTORY RESET </span>
</span><span class='line'><span class="cm"> * 1. user selects &quot;factory reset&quot; </span>
</span><span class='line'><span class="cm"> * 2. main system writes &quot;--wipe_data&quot; to /cache/recovery/command </span>
</span><span class='line'><span class="cm"> * 3. main system reboots into recovery </span>
</span><span class='line'><span class="cm"> * 4. get_args() writes BCB with &quot;boot-recovery&quot; and &quot;--wipe_data&quot; </span>
</span><span class='line'><span class="cm"> *    -- after this, rebooting will restart the erase -- </span>
</span><span class='line'><span class="cm"> * 5. erase_volume() reformats /data </span>
</span><span class='line'><span class="cm"> * 6. erase_volume() reformats /cache </span>
</span><span class='line'><span class="cm"> * 7. finish_recovery() erases BCB </span>
</span><span class='line'><span class="cm"> *    -- after this, rebooting will restart the main system -- </span>
</span><span class='line'><span class="cm"> * 8. main() calls reboot() to boot main system </span>
</span><span class='line'><span class="cm"> * </span>
</span><span class='line'><span class="cm"> * OTA INSTALL </span>
</span><span class='line'><span class="cm"> * 1. main system downloads OTA package to /cache/some-filename.zip </span>
</span><span class='line'><span class="cm"> * 2. main system writes &quot;--update_package=/cache/some-filename.zip&quot; </span>
</span><span class='line'><span class="cm"> * 3. main system reboots into recovery </span>
</span><span class='line'><span class="cm"> * 4. get_args() writes BCB with &quot;boot-recovery&quot; and &quot;--update_package=...&quot; </span>
</span><span class='line'><span class="cm"> *    -- after this, rebooting will attempt to reinstall the update -- </span>
</span><span class='line'><span class="cm"> * 5. install_package() attempts to install the update </span>
</span><span class='line'><span class="cm"> *    NOTE: the package install must itself be restartable from any point </span>
</span><span class='line'><span class="cm"> * 6. finish_recovery() erases BCB </span>
</span><span class='line'><span class="cm"> *    -- after this, rebooting will (try to) restart the main system -- </span>
</span><span class='line'><span class="cm"> * 7. ** if install failed ** </span>
</span><span class='line'><span class="cm"> *    7a. prompt_and_wait() shows an error icon and waits for the user </span>
</span><span class='line'><span class="cm"> *    7b; the user reboots (pulling the battery, etc) into the main system </span>
</span><span class='line'><span class="cm"> * 8. main() calls maybe_install_firmware_update() </span>
</span><span class='line'><span class="cm"> *    ** if the update contained radio/hboot firmware **: </span>
</span><span class='line'><span class="cm"> *    8a. m_i_f_u() writes BCB with &quot;boot-recovery&quot; and &quot;--wipe_cache&quot; </span>
</span><span class='line'><span class="cm"> *        -- after this, rebooting will reformat cache &amp; restart main system -- </span>
</span><span class='line'><span class="cm"> *    8b. m_i_f_u() writes firmware image into raw cache partition </span>
</span><span class='line'><span class="cm"> *    8c. m_i_f_u() writes BCB with &quot;update-radio/hboot&quot; and &quot;--wipe_cache&quot; </span>
</span><span class='line'><span class="cm"> *        -- after this, rebooting will attempt to reinstall firmware -- </span>
</span><span class='line'><span class="cm"> *    8d. bootloader tries to flash firmware </span>
</span><span class='line'><span class="cm"> *    8e. bootloader writes BCB with &quot;boot-recovery&quot; (keeping &quot;--wipe_cache&quot;) </span>
</span><span class='line'><span class="cm"> *        -- after this, rebooting will reformat cache &amp; restart main system -- </span>
</span><span class='line'><span class="cm"> *    8f. erase_volume() reformats /cache </span>
</span><span class='line'><span class="cm"> *    8g. finish_recovery() erases BCB </span>
</span><span class='line'><span class="cm"> *        -- after this, rebooting will (try to) restart the main system -- </span>
</span><span class='line'><span class="cm"> * 9. main() calls reboot() to boot main system </span>
</span><span class='line'><span class="cm"> * </span>
</span><span class='line'><span class="cm"> * SECURE FILE SYSTEMS ENABLE/DISABLE </span>
</span><span class='line'><span class="cm"> * 1. user selects &quot;enable encrypted file systems&quot; </span>
</span><span class='line'><span class="cm"> * 2. main system writes &quot;--set_encrypted_filesystems=on|off&quot; to </span>
</span><span class='line'><span class="cm"> *    /cache/recovery/command </span>
</span><span class='line'><span class="cm"> * 3. main system reboots into recovery </span>
</span><span class='line'><span class="cm"> * 4. get_args() writes BCB with &quot;boot-recovery&quot; and </span>
</span><span class='line'><span class="cm"> *    &quot;--set_encrypted_filesystems=on|off&quot; </span>
</span><span class='line'><span class="cm"> *    -- after this, rebooting will restart the transition -- </span>
</span><span class='line'><span class="cm"> * 5. read_encrypted_fs_info() retrieves encrypted file systems settings from /data </span>
</span><span class='line'><span class="cm"> *    Settings include: property to specify the Encrypted FS istatus and </span>
</span><span class='line'><span class="cm"> *    FS encryption key if enabled (not yet implemented) </span>
</span><span class='line'><span class="cm"> * 6. erase_volume() reformats /data </span>
</span><span class='line'><span class="cm"> * 7. erase_volume() reformats /cache </span>
</span><span class='line'><span class="cm"> * 8. restore_encrypted_fs_info() writes required encrypted file systems settings to /data </span>
</span><span class='line'><span class="cm"> *    Settings include: property to specify the Encrypted FS status and </span>
</span><span class='line'><span class="cm"> *    FS encryption key if enabled (not yet implemented) </span>
</span><span class='line'><span class="cm"> * 9. finish_recovery() erases BCB </span>
</span><span class='line'><span class="cm"> *    -- after this, rebooting will restart the main system -- </span>
</span><span class='line'><span class="cm"> * 10. main() calls reboot() to boot main system </span>
</span><span class='line'><span class="cm"> */</span>
</span></code></pre></td></tr></table></div></figure>


<p>前面也说过，RecoverySystem#installPackage(path)将"boot-recovery"写入BCB的command字段，重启之后进入Recovery进行升级。 那Recovery是从哪里拿到升级包的路径呢?</p>

<p>从注释中找到答案，Recovery服务通过/cache来和主系统交互（注释第一行）。执行RecoverySystem#installPackage(path)之后会将path路径写入<em>/cache/recovery/command</em>中(命令大概是这样:&ndash;update_package=[path])，然后Recovery服务读取到update package的命令之后就进行升级。 除了升级命令之外，常用的还有wipe data、wipe cache等命令，都是类似地将命令写入command文件中与Recovery服务交互。Android的设置中的恢复出厂设置其实就是写了一个wipe data命令到 command文件中，让Recovery服务启动时去重置数据。</p>

<p>另外，Recovery服务在读取到 <em>/cache/recovery/command</em>中的命令之后，还会将此命令写入到BCB控制块的recovery字段，主要是用来防止在升级等过程中突然断电，再次重启之后仍然能够进入Recovery，继续之前的升级功能。在升级等操作完成之后会清空BCB和/cache/recovery/command，避免下次重启之后仍然进入Recovery， 这些都是一些细节问题。</p>

<p>Recovery服务的具体流程可以看下面这张图：</p>

<p><img src="/images/articles/android_boot/recovery_service.png" alt="recovery_service_process" /></p>

<p><strong>总结</strong></p>

<p>1、Recovery服务通过/cache来和主系统交互，Andorid系统一般是将命令写入/cache/recovery/command中来和Recovery服务进行交互。</p>

<p>2、Recovery服务能够做的功能有：工厂重置、OTA升级、安全文件系统的启用/禁用。</p>

<h3>FastBoot模式（线刷）</h3>

<p>Android启动除了正常模式和Recovery模式之外还有一个模式：FastBoot模式。</p>

<p>Recovery模式下的刷机通常称之为”卡刷“，因为升级包必须放在Android文件系统中，然后进行升级。FastBoot模式下的刷机称之为”线刷“，必须通过手机和电脑建立USB连接进行分区的烧录。在某些情况下，比如手机刷成砖头无法进入Recovery模式，可以进入fastboot模式通过线刷来恢复。</p>

<p>线刷一般也是通过组合按键进入，个人理解FastBoot模式是BootLoader程序的一部分，所以需要BootLoader支持。另外，也可以通过<code>adb reboot bootloader</code>进入FastBoot模式（如果成砖头了就只能组合按键进入了）。进入FastBoot模式之后，就可以通过在电脑端执行fastboot命令来将固件刷入到Android中。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='powershell'><span class='line'><span class="n">fastboot</span> <span class="n">devices</span>
</span><span class='line'><span class="n">fastboot</span> <span class="n">flash</span> <span class="n">bootloader</span> <span class="n">u-boot</span><span class="p">.</span><span class="n">bin</span>
</span><span class='line'><span class="n">fastboot</span> <span class="n">flash</span> <span class="n">kernel</span> <span class="n">uImage</span>
</span><span class='line'><span class="n">fastboot</span> <span class="n">flash</span> <span class="n">system</span> <span class="n">system</span><span class="p">.</span><span class="n">img</span>
</span><span class='line'><span class="n">fastboot</span> <span class="n">flash</span> <span class="n">userdata</span> <span class="n">userdata</span><span class="p">.</span><span class="n">img</span>
</span><span class='line'><span class="n">fastboot</span> <span class="n">flash</span> <span class="n">ramdisk</span> <span class="n">ramdisk-uboot</span><span class="p">.</span><span class="n">img</span>
</span><span class='line'><span class="n">fastboot</span> <span class="n">erase</span> <span class="n">system</span> <span class="c">#擦除system分区</span>
</span><span class='line'><span class="n">fastboot</span> <span class="n">erase</span> <span class="n">cache</span> <span class="c">#擦除cache分区</span>
</span><span class='line'><span class="n">fastboot</span> <span class="n">erase</span> <span class="n">userdata</span> <span class="c">#擦除userdata分区</span>
</span><span class='line'><span class="n">fastboot</span> <span class="n">reboot</span>
</span><span class='line'><span class="p">...</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>至此，Android的启动流程大概讲完了，最后稍稍总结一下：</strong></p>

<p>1、Android启动有三种情况：正常启动、进入Recovery模式、进入FastBoot模式。</p>

<p>2、通过组合键或者adb命令进入Recovery模式，可以进行工厂重置、OTA升级、安全文件系统的启用/禁用等功能，其中Recovery服务通过/cache跟主系统通信，还涉及到一个BCB的概念。这种方式称之为”卡刷“。</p>

<p>3、通过组合键或者adb命令进入FastBoot模式，通过与PC的连接进行固件烧录。这种方式称之为”线刷"。</p>

<h3>参考资料</h3>

<ul>
<li><a href="http://www.cnblogs.com/bluestorm/p/3340894.html">http://www.cnblogs.com/bluestorm/p/3340894.html</a></li>
<li><a href="https://juejin.im/entry/57664abedf0eea0062f4dea8">https://juejin.im/entry/57664abedf0eea0062f4dea8</a></li>
<li><a href="https://juejin.im/entry/57382e1f2e958a0069cc8eae">https://juejin.im/entry/57382e1f2e958a0069cc8eae</a></li>
</ul>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">放开那个猴子</span></span>

      




<time class='entry-date' datetime='2018-03-24T09:48:26+08:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>24</span><span class='date-suffix'>th</span>, <span class='date-year'>2018</span></span> <span class='time'>9:48 am</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/bootloader/'>bootloader</a>, <a class='category' href='/blog/categories/fastboot/'>fastboot</a>, <a class='category' href='/blog/categories/ota/'>ota</a>, <a class='category' href='/blog/categories/recovery/'>recovery</a>, <a class='category' href='/blog/categories/qi-dong-liu-cheng/'>启动流程</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://www.monkeyliu.com/blog/2018/03/24/android-boot/" data-via="" data-counturl="http://www.monkeyliu.com/blog/2018/03/24/android-boot/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2017/11/09/android-theme-style-attr/" title="Previous Post: Android之Theme、Style、Attr">&laquo; Android之Theme、Style、Attr</a>
      
      
        <a class="basic-alignment right" href="/blog/2018/04/08/path-tracing/" title="Next Post: 路径动画的实现方案">路径动画的实现方案 &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2018/04/08/path-tracing/">路径动画的实现方案</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/03/24/android-boot/">Andorid启动流程探索</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/11/09/android-theme-style-attr/">Android之Theme、Style、Attr</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/10/23/keyevent-dispatch/">Android按键事件分发机制</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/02/28/androidnfc/">Android NFC开发入门</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2018 - 放开那个猴子 -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
